<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Ghost Keyboard v2.1</title>
    
    <!-- Screenshot Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <!-- Supabase SDK -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
        /* --- TEMEL AYARLAR & MOBƒ∞L UYUMLULUK --- */
        :root {
            --bg-color: #050505; --text-color: #e0e0e0; --key-bg: #2d2d30; --key-active: #fff;
            --accent-color: #00ff9d; --glow-color: rgba(0, 255, 157, 0.4);
            --bg-gradient: radial-gradient(circle at 50% 50%, #05150a 0%, #000 100%);
            --key-width: 9%;
        }
        body.theme-easy { --accent-color: #00f2ff; --glow-color: rgba(0, 242, 255, 0.4); --bg-gradient: radial-gradient(circle at 50% 50%, #0a1525 0%, #000 100%); }
        body.theme-normal { --accent-color: #00ff9d; --glow-color: rgba(0, 255, 157, 0.4); --bg-gradient: radial-gradient(circle at 50% 50%, #05150a 0%, #000 100%); }
        body.theme-hard { --accent-color: #ff003c; --glow-color: rgba(255, 0, 60, 0.4); --bg-gradient: radial-gradient(circle at 50% 50%, #250505 0%, #000 100%); }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; user-select: none; }
        
        body {
            background: var(--bg-gradient); 
            color: var(--text-color); 
            font-family: 'Courier New', Courier, monospace;
            margin: 0; 
            /* Mobil Kaydƒ±rma Sorunu √á√∂z√ºm√º */
            height: 100dvh; 
            width: 100vw;
            overflow: hidden; 
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            touch-action: manipulation;
            transition: background 0.5s ease;
        }

        .scanline { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(to bottom, rgba(255,255,255,0), rgba(255,255,255,0) 50%, rgba(0,0,0,0.1) 50%, rgba(0,0,0,0.1)); background-size: 100% 4px; pointer-events: none; z-index: 0; }
        
        .container { 
            width: 100%; 
            max-width: 850px; 
            height: 100%;
            display: flex; 
            flex-direction: column; 
            justify-content: center; 
            align-items: center; 
            padding: 20px; 
            position: relative; 
            z-index: 2; 
        }

        /* --- BA≈ûLANGI√á EKRANI --- */
        .start-layout { 
            display: flex; 
            flex-direction: column; 
            width: 100%; 
            height: 100%;
            justify-content: center; /* Dikey ortalama */
            align-items: center; 
            gap: 20px;
        }
        
        @media (min-width: 768px) { 
            .start-layout { flex-direction: row; align-items: flex-start; justify-content: space-between; height: auto; padding-top: 50px; } 
            .left-panel, .right-panel { flex: 1; width: 100%; } 
            .right-panel { max-width: 350px; } 
        }

        .logo-area { text-align: center; margin-bottom: 10px; }
        .ghost-icon { font-size: 3rem; display: block; animation: float 3s infinite; filter: drop-shadow(0 0 10px var(--glow-color)); }
        @keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }
        h1 { font-size: 1.8rem; margin: 0; color: #fff; line-height: 0.9; }
        h1 span { color: var(--accent-color); text-shadow: 0 0 15px var(--glow-color); }

        .tutorial-box { background: #111; border: 1px solid #333; border-radius: 12px; padding: 10px; width: 100%; text-align: left; margin-bottom: 15px; display: none; } /* Mobilde yer kaplamasƒ±n diye gizli */
        @media (min-width: 768px) { .tutorial-box { display: block; } }

        .name-input { background: transparent; border: none; border-bottom: 2px solid var(--accent-color); color: #fff; font-family: 'Courier New', monospace; font-size: 1.2rem; width: 100%; text-align: center; padding: 10px; outline: none; margin-bottom: 20px; }
        
        .btn-row { display: flex; width: 100%; margin-bottom: 10px; gap: 5px; }
        .mode-btn { background: transparent; border: 1px solid #333; color: #666; padding: 12px; border-radius: 6px; cursor: pointer; font-size: 0.8rem; font-weight: bold; flex: 1; text-align: center; transition: 0.2s; }
        .mode-btn.active { background: var(--accent-color); color: #000; border-color: var(--accent-color); box-shadow: 0 0 10px var(--glow-color); }
        
        .main-btn { background: var(--accent-color); color: #000; border: none; width: 100%; padding: 16px; font-size: 1.2rem; font-weight: 900; border-radius: 10px; cursor: pointer; box-shadow: 0 0 20px var(--glow-color); margin-top: 10px; }
        .secondary-btn { background: transparent; border: 2px solid var(--accent-color); color: var(--accent-color); width: 100%; padding: 15px; border-radius: 10px; cursor: pointer; font-weight: bold; margin-top: 10px; max-width: 400px; }

        /* --- OYUN EKRANI --- */
        .timer-container { text-align: center; margin-bottom: 5px; }
        #timer { font-size: 3rem; font-weight: 900; color: var(--accent-color); text-shadow: 0 0 20px var(--glow-color); font-variant-numeric: tabular-nums; }
        
        .target-box { background: rgba(255,255,255,0.05); border: 1px dashed #444; border-radius: 12px; padding: 15px; min-height: 70px; display: flex; align-items: center; justify-content: center; text-align: center; margin-bottom: 10px; width: 100%; max-width: 450px;}
        .target-text { font-size: 1.1rem; color: #fff; font-weight: 600; line-height: 1.3; }
        
        .input-box { font-size: 1.3rem; color: var(--accent-color); border-bottom: 2px solid #333; min-height: 35px; margin: 10px 0; text-align: center; white-space: pre; width: 100%; max-width: 450px; }
        
        .keyboard { display: flex; flex-direction: column; width: 100%; max-width: 450px; padding: 5px 0; gap: 5px; }
        .row { display: flex; justify-content: center; width: 100%; gap: 3px; }
        .key { background: var(--key-bg); color: #fff; height: 44px; border-radius: 5px; display: flex; align-items: center; justify-content: center; flex: 1; cursor: pointer; }
        .key span { opacity: 0; } .key.special span, .key.enter span { opacity: 1; }
        .key:active, .key.active-key { background: #555; transform: scale(0.95); }
        .key.enter { flex: 2; background: var(--accent-color); color: #000; font-weight: bold; }
        .key.space { flex: 5; font-size: 0.8rem; }
        .row.staggered { padding: 0 10px; }

        /* --- SONU√á EKRANI --- */
        #result-capture-area {
            width: 100%; 
            max-width: 380px; 
            padding: 20px; 
            background: #050505; 
            text-align: center; 
            border: 1px solid #333; 
            border-radius: 15px;
            margin: 0 auto;
        }
        .roast-box { background: #111; border: 1px solid var(--accent-color); color: #fff; padding: 10px; border-radius: 8px; margin-bottom: 15px; text-align: center; font-style: italic; font-size: 0.9rem; line-height: 1.4; box-shadow: 0 0 10px var(--glow-color); }
        .stats-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; margin-bottom: 15px; }
        .stat-card { background: #151515; padding: 8px; border-radius: 8px; text-align: center; }
        .stat-val { font-size: 1.2rem; font-weight: bold; color: #fff; display: block; }
        .stat-lbl { font-size: 0.6rem; color: #666; margin-top: 2px; }

        /* Sallanma Animasyonu */
        @keyframes shake { 0% { transform: translateX(0); } 25% { transform: translateX(-5px); } 75% { transform: translateX(5px); } 100% { transform: translateX(0); } }
        .shake-screen { animation: shake 0.3s; }
        .error-glow { text-shadow: 0 0 15px #ff0000 !important; color: #ff5555 !important; }

        #start-screen { display: none; width: 100%; }
        #game-screen, #result-screen { display: none; width: 100%; height: 100%; flex-direction: column; justify-content: center; align-items: center;}
    </style>
</head>
<body class="theme-easy">

    <div class="scanline"></div>

    <div class="container">
        <!-- START SCREEN -->
        <div id="start-screen">
            <div class="start-layout">
                <div class="logo-area">
                    <span class="ghost-icon">üëª</span>
                    <h1>GHOST<br><span>KEYBOARD</span></h1>
                </div>
                
                <div class="tutorial-box">
                    <div>üëÄ Read. ‚å®Ô∏è Type blindly. üß† Muscle memory.</div>
                </div>

                <div style="width:100%; max-width: 350px;">
                    <input type="text" id="username-input" class="name-input" placeholder="ENTER USERNAME" maxlength="12" onchange="saveUsername(this.value)">
                    
                    <div class="btn-row" id="diff-row">
                        <div class="mode-btn active" onclick="setDiff('easy', this)">NOOB</div>
                        <div class="mode-btn" onclick="setDiff('normal', this)">PRO</div>
                        <div class="mode-btn" onclick="setDiff('hard', this)">HACKER</div>
                    </div>
                    <div class="btn-row" id="lang-row">
                        <div class="mode-btn" onclick="setLang('en', this)">ENG üá∫üá∏</div>
                        <div class="mode-btn active" onclick="setLang('tr', this)">TUR üáπüá∑</div>
                    </div>
                    
                    <button class="main-btn" onclick="startGame()">START GAME</button>
                    
                    <div style="margin-top:20px; text-align:center; font-size:0.8rem; color:#444;">
                        TOP HACKER: <span id="top-hacker">Loading...</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- GAME SCREEN -->
        <div id="game-screen">
            <div class="timer-container">
                <div id="timer">0.0</div>
            </div>
            <div class="target-box"><span class="target-text" id="target-text">...</span></div>
            <div class="input-box" id="input-box-area"><span id="user-input"></span><span style="animation:blink 1s infinite">|</span></div>
            <div class="keyboard" id="kb-container"></div>
        </div>

        <!-- RESULT SCREEN -->
        <div id="result-screen">
            <div id="result-capture-area">
                <h2 style="color:#fff; margin:0 0 10px 0; text-shadow: 0 0 10px rgba(255,255,255,0.5); font-family: 'Courier New', monospace;">GAME OVER</h2>
                
                <div class="roast-box" id="roast-msg">...</div>
                
                <div style="margin-bottom:15px;">
                    <span style="font-size:3rem; font-weight:900; color:var(--accent-color); display:block;" id="res-score">0</span>
                    <span style="font-size:0.7rem; color:#666; letter-spacing:2px;">TOTAL SCORE</span>
                </div>
                
                <div class="stats-grid">
                    <div class="stat-card"><span class="stat-val" id="res-wpm">0</span><span class="stat-lbl">WPM</span></div>
                    <div class="stat-card"><span class="stat-val" id="res-acc">0%</span><span class="stat-lbl">ACC</span></div>
                    <div class="stat-card"><span class="stat-val" id="res-time">0s</span><span class="stat-lbl">TIME</span></div>
                </div>
                
                <div style="font-size:0.8rem; color:#888;">
                    HACKER: <span id="res-player" style="color:#fff;"></span>
                </div>
                <div style="font-size:0.6rem; color:#444; margin-top:5px;">ghostkeyboard.net</div>
            </div>
            
            <div style="width:100%; max-width:380px; margin-top:15px;">
                <button class="main-btn" onclick="resetGame()">AGAIN</button>
                <button class="secondary-btn" id="share-btn" onclick="shareScreenshot()">üì∏ SHARE RESULT</button>
            </div>
        </div>
    </div>

    <script>
        // --- CONFIG ---
        const SUPABASE_URL = 'https://dhqegitqiarogxivzcyv.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRocWVnaXRxaWFyb2d4aXZ6Y3l2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM5NzAwMzMsImV4cCI6MjA3OTU0NjAzM30.qnBHT5grVgmoMk1yCQA2_R8J-Q5MBXW3W05bXRS7Xoc';
        let supabase;
        try { supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY); } catch(e){}

        // --- DATA ---
        const phrases = {
            en: {
                easy: ["linux", "sudo", "code", "joker", "bond", "nasa", "tesla", "mars", "apple", "swift", "react", "node", "java", "ruby", "perl", "bash", "root", "user", "data", "byte", "file", "disk", "hack", "wifi", "grid", "neon", "flux", "core", "bios", "cmos"],
                normal: ["hello world", "winter is coming", "show me the money", "just do it", "control is an illusion", "there is no spoon", "access denied", "system failure", "buffer overflow", "blue screen of death", "fatal error", "stack trace", "brute force", "neural network", "machine learning", "quantum computing", "artificial intelligence","Her ≈üey a≈ük i√ßin", "bizde aileye yamuk olmaz", "Ben aslƒ±nda yoƒüumm"],
                hard: ["sudo rm -rf /", "console.log('Error');", "404: Page not found.", "Houston, we have a problem.", "DROP TABLE users;", "alert('XSS Attack');", "while(true){fork();}", "git commit -m 'fix bug'", "docker-compose up -d", "kubectl get pods","Ay bu k√º√ß√ºk, narin, hassas ve orantƒ±lƒ± kulaklarƒ±m neler duyuyor", "Ne kadar da inanarak bo≈ü konu≈üuyor"]
            },
            tr: {
                easy: ["yazilim", "kod", "kaos", "simit", "kedi", "ezel", "ramiz", "uzay", "vatan", "millet", "veri", "fare", "ekran", "kasa", "modem", "kablo", "dosya", "klasor", "sifre", "hakim", "savci", "polis", "radar", "pilot", "robot", "siber", "bulut", "sunucu", "linux", "sudo", "code", "joker", "bond", "nasa", "tesla", "mars", "apple", "swift", "react", "node", "java", "ruby", "perl", "bash", "root", "user", "data", "byte", "file", "disk", "hack", "wifi", "grid", "neon", "flux", "core", "bios", "cmos"],
                normal: ["kod calisiyor elleme", "o gemi bir gun gelecek", "mesele olmek degil", "burasi karisacak", "sisteme giris yapildi", "baglanti koptu", "guvenlik duvari", "veri tabani hatasi", "mavi ekran verdi", "format atmak lazim", "klavye delikanlisi", "yasasin irkimiz", "bir gece ansizin", "hello world", "winter is coming", "show me the money", "just do it", "control is an illusion", "there is no spoon", "access denied", "system failure", "buffer overflow", "blue screen of death", "fatal error", "stack trace", "brute force", "neural network", "machine learning", "quantum computing", "artificial intelligence", "Her ≈üey a≈ük i√ßin", "biz de aileye yamuk olmaz", "Ben aslƒ±nda yoƒüumm"],
                hard: ["Noktali virgul nerede;", "SELECT * FROM dertler;", "Abi bana site yapsana?", "404 Sayfa Bulunamadi.", "sudo apt-get update", "console.log('Selam');", "if(money < 0) panic();", "git push origin master", "npm install dertler", "Bug√ºn de ba≈ükasƒ± adƒ±na utandƒ±k", "kubectl get pods", "sudo rm -rf /", "console.log('Error');", "404: Page not found.", "Houston, we have a problem.", "DROP TABLE users;", "alert('XSS Attack');", "while(true){fork();}", "git commit -m 'fix bug'", "docker-compose up -d", "Ay bu k√º√ß√ºk, narin, hassas ve orantƒ±lƒ± kulaklarƒ±m neler duyuyor", "Ne kadar da inanarak bo≈ü konu≈üuyor"]
            }
        };

        // --- STATE & AUDIO ---
        const config = { diff: 'easy', lang: 'tr', backspace: true };
        let state = { active: false, target: "", input: "", start: 0, timer: null };
        let username = "";
        let audioCtx = null;

        function initAudio() {
            if (!audioCtx) {
                const AudioContext = window.AudioContext || window.webkitAudioContext;
                if(AudioContext) audioCtx = new AudioContext();
            }
            if(audioCtx && audioCtx.state === 'suspended') audioCtx.resume();
        }

        function playClick(isEnter = false) {
            if(!audioCtx) return;
            try {
                const t = audioCtx.currentTime;
                const osc = audioCtx.createOscillator(); const gain = audioCtx.createGain();
                osc.frequency.setValueAtTime(isEnter ? 600 : 800, t);
                osc.frequency.exponentialRampToValueAtTime(100, t + 0.05);
                gain.gain.setValueAtTime(0.1, t); gain.gain.exponentialRampToValueAtTime(0.001, t + 0.05);
                osc.connect(gain); gain.connect(audioCtx.destination); osc.start(); osc.stop(t + 0.05);
            } catch(e) {}
        }

        window.onload = () => {
            const saved = localStorage.getItem('ghostUsername');
            if(saved) username = sanitizeUsername(saved);
            document.getElementById('start-screen').style.display = 'block';
            getTopScore();
        };

        async function getTopScore() {
            if(!supabase) return;
            const { data } = await supabase.from('scores').select('username, score').order('score', {ascending:false}).limit(1);
            if(data && data[0]) document.getElementById('top-hacker').textContent = `${data[0].username} (${data[0].score})`;
        }

        // --- GAME LOGIC ---
        function startGame() {
            initAudio(); // MOBƒ∞LDE SES ƒ∞√áƒ∞N KRƒ∞Tƒ∞K

            const inputEl = document.getElementById('username-input');
            username = sanitizeUsername(inputEl.value);
            if(!username || username.length < 2) { alert("Enter a valid username!"); inputEl.focus(); return; }
            saveUsername(username);
            playClick();

            const pool = phrases[config.lang][config.diff];
            state.target = pool[Math.floor(Math.random() * pool.length)];
            state.input = ""; state.active = true; state.start = Date.now();

            document.getElementById('start-screen').style.display = 'none';
            document.getElementById('result-screen').style.display = 'none';
            document.getElementById('game-screen').style.display = 'flex';
            
            initKeyboard();
            document.getElementById('target-text').textContent = state.target;
            document.getElementById('user-input').textContent = "";
            
            if(state.timer) clearInterval(state.timer);
            state.timer = setInterval(() => {
                document.getElementById('timer').textContent = ((Date.now()-state.start)/1000).toFixed(1);
            }, 50);
        }

        function finish() {
            if(!state.active) return;
            state.active = false; clearInterval(state.timer);
            
            const timeTaken = (Date.now()-state.start)/1000;
            const acc = calcAcc(state.target, state.input);
            const wpm = Math.round((state.input.length/5)/(timeTaken/60)) || 0;
            const finalScore = Math.floor(wpm * (acc / 100));

            saveScoreToCloud(finalScore, wpm, acc, timeTaken);

            document.getElementById('game-screen').style.display = 'none';
            document.getElementById('result-screen').style.display = 'flex';
            
            document.getElementById('res-score').textContent = finalScore;
            document.getElementById('res-wpm').textContent = wpm;
            document.getElementById('res-acc').textContent = acc + "%";
            document.getElementById('res-time').textContent = timeTaken.toFixed(1) + "s";
            document.getElementById('roast-msg').textContent = getRoast(acc, wpm);
            document.getElementById('res-player').textContent = username;
        }

        function handle(char, el) {
            if(!state.active) return;
            if(navigator.vibrate) navigator.vibrate(5);
            if(el) { el.classList.add('active-key'); setTimeout(()=>el.classList.remove('active-key'), 100); }

            if(char === 'BACKSPACE') {
                playClick(); state.input = state.input.slice(0, -1);
            } else {
                state.input += char;
                const idx = state.input.length - 1;
                let expected = config.diff !== 'hard' ? (state.target[idx] || "").toLowerCase() : (state.target[idx] || "");
                let inputChar = config.diff !== 'hard' ? char.toLowerCase() : char;
                
                if (expected && inputChar !== expected) {
                    document.body.classList.add('shake-screen');
                    document.getElementById('input-box-area').classList.add('error-glow');
                    setTimeout(() => {
                        document.body.classList.remove('shake-screen');
                        document.getElementById('input-box-area').classList.remove('error-glow');
                    }, 300);
                } else {
                    playClick();
                }
            }
            document.getElementById('user-input').textContent = state.input;
        }

        // --- NEW ROAST LOGIC ---
        function getRoast(acc, wpm) {
            const pick = (arr) => arr[Math.floor(Math.random() * arr.length)];
            if (wpm === 0) return "AFK? Did you fall asleep? üí§";
            if (acc === 0) return "You missed everything. Are you a Stormtrooper? üî´";
            if (wpm > 250) return pick(["Nice script, bro. ü§ñ", "CYBORG DETECTED ü§ñ", "He is the One. üï∂Ô∏è", "Are you Mr. Robot? üë®‚Äçüíª"]);
            if (wpm >= 100 && acc >= 90) {
                const opts = ["UNLIMITED POWER! ‚ö°"];
                if (acc >= 98) opts.push("He is the One. üï∂Ô∏è (Matrix Code Rain)");
                return pick(opts);
            }
            if (wpm >= 80 && wpm < 100 && acc >= 85) {
                const opts = ["The Force is strong. üåå", "So close! ü§è"];
                if (acc >= 95) opts.push("Legolas aim! üèπ (Elven precision)");
                return pick(opts);
            }
            if (wpm >= 60 && acc < 85) {
                const opts = [];
                if (wpm >= 80 && acc < 60) opts.push("My eyes! üòµ Too fast, too furious, too wrong!");
                if (wpm >= 60 && acc < 70) opts.push("Stormtrooper Aim detected. Pew pew! üî´ (0 hits)");
                if (wpm >= 70) opts.push("Control yourself, Padawan. üßò", "One typo ruined your career. üìâ");
                if (opts.length === 0) return "Slow down!";
                return pick(opts);
            }
            if (wpm < 50 && acc >= 90) {
                const opts = ["Slow... but safe. üöó", "Grandma speed. üëµ"];
                if (wpm < 30 && acc === 100) opts.push("Dial-up Internet vibes... üêå");
                if (wpm < 40 && acc >= 95) opts.push("Ent-ish speed. üå≥");
                return pick(opts);
            }
            if (wpm >= 40 && wpm < 70 && acc >= 85) {
                const opts = ["Not great, not terrible. ‚ò¢Ô∏è"];
                if (wpm < 60) opts.push("NPC Energy. üòê (Need more coffee)");
                return pick(opts);
            }
            if (wpm < 40 && acc < 60) {
                return pick(["Toaster typing? üçû", "Using elbows? üí™", "My eyes hurt. ü´£", "Try using fingers. üñêÔ∏è", "You shall not pass! üßô‚Äç‚ôÇÔ∏è", "Please delete the app. üíÄ"]);
            }
            return "Emotional Damage. üíî (Try again)";
        }

        // --- MOBILE SHARE LOGIC (FIXED) ---
        async function shareScreenshot() {
            const btn = document.getElementById('share-btn');
            const originalText = "üì∏ SHARE RESULT";
            btn.textContent = "‚è≥ Processing..."; btn.disabled = true;

            const resultArea = document.getElementById('result-capture-area');

            try {
                const canvas = await html2canvas(resultArea, { backgroundColor: '#050505', scale: 2, logging: false, useCORS: true, allowTaint: true });
                canvas.toBlob(async (blob) => {
                    if (!blob) { alert("Error generating image."); resetBtn(); return; }
                    
                    const file = new File([blob], "ghost_score.png", { type: "image/png" });
                    const shareData = { title: 'Ghost Keyboard', text: `I scored ${document.getElementById('res-score').textContent} on Ghost Keyboard! üëª`, files: [file] };

                    if (navigator.share && navigator.canShare && navigator.canShare(shareData)) {
                        try { await navigator.share(shareData); btn.textContent = "‚úÖ Shared!"; } 
                        catch (err) { if (err.name !== 'AbortError') downloadImage(canvas); }
                    } else {
                        downloadImage(canvas);
                    }
                    resetBtn();
                }, 'image/png');
            } catch (e) { console.error(e); alert("Failed to capture."); resetBtn(); }

            function resetBtn() { setTimeout(() => { btn.textContent = originalText; btn.disabled = false; }, 2000); }
            function downloadImage(cnv) {
                const link = document.createElement('a'); link.download = `ghost_score_${Date.now()}.png`; link.href = cnv.toDataURL();
                document.body.appendChild(link); link.click(); document.body.removeChild(link);
                btn.textContent = "‚¨áÔ∏è Downloaded";
            }
        }

        // --- KEYBOARD BUILDER ---
        function initKeyboard() {
            const c = document.getElementById('kb-container'); if(!c) return; c.innerHTML = '';
            let r = config.lang === 'tr' ? ["qwertyuƒ±opƒü√º", "asdfghjkl≈üi", "zxcvbnm√∂√ß"] : ["qwertyuiop", "asdfghjkl", "zxcvbnm"];
            
            const makeRow = (chars) => {
                let div = document.createElement('div'); div.className='row';
                chars.split('').forEach(ch => {
                    let k = document.createElement('div'); k.className='key'; k.innerHTML=`<span>${ch.toUpperCase()}</span>`;
                    const h = (e)=>{e.preventDefault(); handle(ch, k)}; k.ontouchstart=h; k.onmousedown=h; div.appendChild(k);
                }); return div;
            };
            c.appendChild(makeRow(r[0]));
            let r2 = makeRow(r[1]); r2.classList.add('staggered'); c.appendChild(r2);
            
            let r3 = document.createElement('div'); r3.className='row';
            let sh = document.createElement('div'); sh.className='key special'; sh.innerHTML='<span>‚áß</span>'; r3.appendChild(sh);
            r[2].split('').forEach(ch => {
                let k = document.createElement('div'); k.className='key'; k.innerHTML=`<span>${ch.toUpperCase()}</span>`;
                const h = (e)=>{e.preventDefault(); handle(ch, k)}; k.ontouchstart=h; k.onmousedown=h; r3.appendChild(k);
            });
            let bk = document.createElement('div'); bk.className='key special'; bk.innerHTML=config.backspace?'<span>‚å´</span>':'<span>üîí</span>';
            const bh = (e)=>{e.preventDefault(); if(config.backspace) handle('BACKSPACE', bk)}; bk.ontouchstart=bh; bk.onmousedown=bh; r3.appendChild(bk);
            c.appendChild(r3);

            let r4 = document.createElement('div'); r4.className='row';
            let k123 = document.createElement('div'); k123.className='key special'; k123.innerHTML='<span>123</span>'; r4.appendChild(k123);
            let spc = document.createElement('div'); spc.className='key space'; spc.innerHTML='<span>space</span>';
            const sh2 = (e)=>{e.preventDefault(); handle(' ', spc)}; spc.ontouchstart=sh2; spc.onmousedown=sh2; r4.appendChild(spc);
            let ent = document.createElement('div'); ent.className='key enter'; ent.innerHTML='<span>GO</span>';
            const eh = (e)=>{e.preventDefault(); finish(); playClick(true);}; ent.ontouchstart=eh; ent.onmousedown=eh; r4.appendChild(ent);
            c.appendChild(r4);
        }

        // --- UTILS ---
        function sanitizeUsername(v) { return v ? v.trim().replace(/[<>'"&]/g, '').substring(0,12) : ''; }
        function saveUsername(v) { username = sanitizeUsername(v); localStorage.setItem('ghostUsername', username); }
        function calcAcc(a,b) {
            if (config.diff !== 'hard') { a = a.toLowerCase(); b = b.toLowerCase(); }
            let m=0, len = Math.max(a.length, b.length); if(len===0)return 0;
            for(let i=0;i<len;i++) if(a[i]===b[i]) m++; return Math.floor((m/len)*100);
        }
        function setDiff(val, btn) { config.diff = val; config.backspace = val !== 'hard'; document.querySelectorAll('#diff-row .mode-btn').forEach(b => b.classList.remove('active')); btn.classList.add('active'); document.body.className = ''; document.body.classList.add('theme-' + val); playClick(); }
        function setLang(val, btn) { config.lang = val; document.querySelectorAll('#lang-row .mode-btn').forEach(b => b.classList.remove('active')); btn.classList.add('active'); playClick(); }
        function resetGame() { document.getElementById('result-screen').style.display = 'none'; document.getElementById('start-screen').style.display = 'block'; document.getElementById('username-input').value = username; }
        async function saveScoreToCloud(score, wpm, acc, time) {
            if (!supabase || wpm > 350 || acc > 100) return;
            await supabase.rpc('submit_score_secure', { p_username: username, p_score: Math.floor(score), p_wpm: Math.floor(wpm), p_accuracy: Math.floor(acc), p_time_taken: time });
        }
    </script>
</body>
</html>
