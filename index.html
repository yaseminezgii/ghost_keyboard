<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ghost Keyboard v2.4 (Lite)</title>
    
    <meta property="og:title" content="Ghost Keyboard Challenge">
    <meta property="og:description" content="Invisible keys. Can you type blindly?">
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

 <style>
        /* --- TEMEL AYARLAR --- */
        :root {
            --bg-color: #050505; --text-color: #e0e0e0; --key-bg: #2d2d30; --key-active: #fff;
            --accent-color: #00ff9d; --glow-color: rgba(0, 255, 157, 0.4);
            --bg-gradient: radial-gradient(circle at 50% 50%, #05150a 0%, #000 100%);
            --key-width: 8.5%;
        }
        body.theme-easy { --accent-color: #00f2ff; --glow-color: rgba(0, 242, 255, 0.4); --bg-gradient: radial-gradient(circle at 50% 50%, #0a1525 0%, #000 100%); }
        body.theme-normal { --accent-color: #00ff9d; --glow-color: rgba(0, 255, 157, 0.4); --bg-gradient: radial-gradient(circle at 50% 50%, #05150a 0%, #000 100%); }
        body.theme-hard { --accent-color: #ff003c; --glow-color: rgba(255, 0, 60, 0.4); --bg-gradient: radial-gradient(circle at 50% 50%, #250505 0%, #000 100%); }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; user-select: none; }
        
        body {
            background: var(--bg-gradient); 
            color: var(--text-color); 
            font-family: 'Courier New', Courier, monospace;
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            min-height: 100vh;
            /* Mobilde adres √ßubuƒüu sorununu √ß√∂zer */
            min-height: 100dvh; 
            margin: 0; 
            overflow-x: hidden;
            overflow-y: auto;
            touch-action: manipulation; 
            transition: background 0.5s ease;
        }

        .container { 
            width: 100%; max-width: 850px; 
            /* Minimum y√ºkseklik ekran boyu kadar */
            min-height: 100vh; min-height: 100dvh;
            display: flex; flex-direction: column; 
            /* DEƒûƒ∞≈ûƒ∞KLƒ∞K: ƒ∞√ßeriƒüi dikeyde tam ortalar */
            justify-content: center;
            align-items: center;
            padding: 10px; gap: 15px;
            position: relative; z-index: 2; 
        }

        .scanline { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(to bottom, transparent 50%, rgba(0,0,0,0.1) 50%); background-size: 100% 4px; pointer-events: none; z-index: 0; }

        /* --- START SCREEN --- */
        /* Start ekranƒ± uzun olabilir, o y√ºzden flex-start kullanƒ±p margin ile itiyoruz */
        #start-screen { width: 100%; display: none; margin: auto 0; }
        
        .start-layout { display: flex; flex-direction: column; width: 100%; gap: 30px; align-items: center; }
        @media (min-width: 768px) { 
            .start-layout { flex-direction: row; align-items: flex-start; justify-content: space-between; } 
            .left-panel, .right-panel { flex: 1; width: 100%; } 
            .right-panel { max-width: 350px; } 
        }

        .logo-area { text-align: center; margin-bottom: 20px; }
        .ghost-icon { font-size: 3.5rem; display: block; animation: float 3s infinite; filter: drop-shadow(0 0 10px var(--glow-color)); }
        @keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }
        h1 { font-size: 2rem; margin: 0; color: #fff; line-height: 0.9; }
        h1 span { color: var(--accent-color); text-shadow: 0 0 15px var(--glow-color); }

        .tutorial-box { background: #111; border: 1px solid #333; border-radius: 12px; padding: 15px; width: 100%; text-align: left; margin-bottom: 20px; }
        .tut-item { display: flex; align-items: center; margin-bottom: 8px; color: #bbb; font-size: 0.85rem; }
        .tut-icon { margin-right: 10px; font-size: 1.1rem; }

        .name-input { background: transparent; border: none; border-bottom: 2px solid var(--accent-color); color: #fff; font-family: 'Courier New', monospace; font-size: 1.2rem; width: 100%; text-align: center; padding: 10px; outline: none; margin-bottom: 20px; }
        
        .mode-btn { background: transparent; border: 1px solid #333; color: #666; padding: 10px; border-radius: 6px; cursor: pointer; font-size: 0.8rem; font-weight: bold; flex: 1; text-align: center; margin: 0 2px; transition: 0.2s; }
        .mode-btn.active { background: var(--accent-color); color: #000; border-color: var(--accent-color); box-shadow: 0 0 10px var(--glow-color); transform: scale(1.05); }
        .btn-row { display: flex; width: 100%; margin-bottom: 10px; }
        
        .main-btn { 
            background: var(--accent-color); color: #000; border: none; width: 100%; 
            padding: 16px; font-size: 1.2rem; font-weight: 900; border-radius: 10px; 
            cursor: pointer; box-shadow: 0 0 20px var(--glow-color); 
            transition: all 0.3s ease; letter-spacing: 1px;
        }
        .main-btn:active { transform: scale(0.98); }

        .secondary-btn {
            background: transparent; border: 2px solid var(--accent-color);
            color: var(--accent-color); width: 100%; padding: 16px; font-size: 1.1rem; font-weight: 900;
            border-radius: 10px; margin-top: 15px; cursor: pointer;
            text-transform: uppercase; letter-spacing: 2px;
            box-shadow: 0 0 15px rgba(0,0,0,0.5); font-family: 'Courier New', monospace;
            transition: all 0.3s ease;
        }
        .secondary-btn:active { transform: scale(0.98); background: rgba(255,255,255,0.1); }

        /* --- LEADERBOARD --- */
        .leaderboard-wrapper { width: 100%; background: rgba(15, 15, 15, 0.9); border: 1px solid #333; border-radius: 12px; padding: 20px; min-height: 250px; display: flex; flex-direction: column; }
        .lb-header { width: 100%; border-bottom: 1px solid #333; padding-bottom: 10px; margin-bottom: 15px; display: flex; flex-direction: column; align-items: center; gap: 5px; }
        .lb-title { color: var(--accent-color); font-size: 1rem; font-weight: bold; }
        .countdown-box { font-size: 0.8rem; color: #666; background: rgba(0,0,0,0.3); padding: 4px 10px; border-radius: 4px; border: 1px solid #222; display: flex; gap: 8px; }
        #daily-timer { color: var(--accent-color); font-weight: bold; }
        .lb-row { display: flex; justify-content: space-between; font-size: 0.85rem; padding: 8px 5px; border-bottom: 1px solid rgba(255,255,255,0.05); }
        .lb-row.highlight { background: rgba(255,255,255,0.1); border-radius: 4px; }
        .lb-rank { width: 30px; color: #666; font-weight: bold; }
        .lb-name { flex-grow: 1; color: #ddd; text-align: left; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 120px;}
        .lb-score { color: var(--accent-color); font-weight: bold; }

        /* --- GAME UI --- */
        #game-screen { 
            display: none; 
            width: 100%; 
            /* Flex-grow ile container i√ßinde yer kaplamasƒ±nƒ± saƒüla, ama ortala */
            flex: 1; 
            flex-direction: column; 
            justify-content: center; 
            align-items: center;
        }

        .timer-container { text-align: center; margin-bottom: 10px; }
        #timer { font-size: 3.5rem; font-weight: 900; color: var(--accent-color); text-shadow: 0 0 20px var(--glow-color); font-variant-numeric: tabular-nums; }
        
        .target-box { 
            background: rgba(255,255,255,0.05); border: 1px dashed #444; 
            border-radius: 12px; padding: 20px; 
            min-height: 80px; width: 100%; max-width: 450px;
            display: flex; align-items: center; justify-content: center; 
            text-align: center; margin-bottom: 10px; 
        }
        .target-text { font-size: 1.4rem; color: #fff; font-weight: 600; line-height: 1.4; }
        
        .input-box { 
            font-size: 1.5rem; color: var(--accent-color); 
            border-bottom: 2px solid #333; min-height: 40px; 
            margin: 15px 0 25px 0; text-align: center; 
            white-space: pre; width: 100%; max-width: 450px; 
        }
        
        .keyboard { display: flex; flex-direction: column; width: 100%; max-width: 420px; padding: 5px 0; }
        
        .row { display: flex; justify-content: center; margin-bottom: 4px; width: 100%; }
        
        .key { background: var(--key-bg); color: #fff; height: 42px; border-radius: 6px; display: flex; align-items: center; justify-content: center; margin: 0 1px; flex: 0 0 auto; width: var(--key-width); cursor: pointer; }
        
        .key span { opacity: 0; } .key.special span, .key.enter span { opacity: 1; }
        .key:active, .key.active-key { background: #555; transform: scale(1.1); }
        
        .key.enter { width: 18% !important; background: var(--accent-color); color: #000; font-weight: bold; }
        .key.space { flex-grow: 1; width: auto !important; font-size: 0.8rem; }
        .row.staggered { padding: 0 1.5%; }

        /* --- RESULT SCREEN --- */
        #result-screen { display: none; width: 100%; height: 100%; flex-direction: column; justify-content: center; align-items: center;}

        #result-capture-area {
            width: 100%; max-width: 400px; padding: 25px; 
            background: #050505; text-align: center; 
            border: 1px solid #333; border-radius: 15px;
            position: relative; overflow: hidden; margin: 0 auto;
        }
        .roast-box { background: #111; border: 1px solid var(--accent-color); color: #fff; padding: 15px; border-radius: 10px; margin-bottom: 15px; text-align: center; font-style: italic; box-shadow: 0 0 15px var(--glow-color); }
        .stats-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-bottom: 20px; }
        .stat-card { background: #151515; padding: 10px; border-radius: 8px; text-align: center; }
        .stat-val { font-size: 1.5rem; font-weight: bold; color: #fff; display: block; }
        .stat-lbl { font-size: 0.6rem; color: #666; margin-top: 5px; }

        .shake-screen { animation: shake 0.3s; }
        @keyframes shake { 0%,100%{transform:translateX(0)} 25%{transform:translateX(-5px)} 75%{transform:translateX(5px)} }
        .error-glow { text-shadow: 0 0 15px #ff0000 !important; color: #ff5555 !important; }
    </style>
</head>
<body class="theme-easy">

    <div class="scanline"></div>

    <div class="container">
        <!-- START SCREEN -->
        <div id="start-screen">
            <div class="start-layout">
                <div class="left-panel">
                    <div class="logo-area">
                        <span class="ghost-icon">üëª</span>
                        <h1>GHOST<br><span>KEYBOARD</span></h1>
                    </div>
                    <div class="tutorial-box">
                        <div class="tut-item"><span class="tut-icon">üëÄ</span><span>Read the phrase.</span></div>
                        <div class="tut-item"><span class="tut-icon">‚å®Ô∏è</span><span>Type blindly (Invisible Keys).</span></div>
                        <div class="tut-item"><span class="tut-icon">üß†</span><span>Trust your muscle memory.</span></div>
                    </div>
                    <input type="text" id="username-input" class="name-input" placeholder="ENTER USERNAME" maxlength="12" onchange="saveUsername(this.value)">
                    <div style="width:100%">
                        <div class="btn-row" id="diff-row">
                            <div class="mode-btn active" onclick="setDiff('easy', this)">NOOB</div>
                            <div class="mode-btn" onclick="setDiff('normal', this)">PRO</div>
                            <div class="mode-btn" onclick="setDiff('hard', this)">HACKER</div>
                        </div>
                        <div class="btn-row" id="lang-row">
                            <div class="mode-btn" onclick="setLang('en', this)">ENG üá∫üá∏</div>
                            <div class="mode-btn active" onclick="setLang('tr', this)">TUR üáπüá∑</div>
                        </div>
                        <button class="main-btn" onclick="startGame()">START GAME</button>
                    </div>
                </div>
                <!-- LEADERBOARD -->
                <div class="right-panel">
                    <div class="leaderboard-wrapper">
                        <div class="lb-header">
                            <div class="lb-title">üèÜ TOP HACKERS</div>
                            <div class="countdown-box"><span>RESET:</span><span id="daily-timer">00:00:00</span></div>
                        </div>
                        <div id="lb-content"><div style="text-align:center;color:#666; margin-top:20px;">Loading...</div></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- GAME SCREEN -->
        <div id="game-screen">
            <div class="timer-container"><div id="timer">0.0</div></div>
            <div class="target-box"><span class="target-text" id="target-text">Loading...</span></div>
            <div class="input-box" id="input-box-area"><span id="user-input"></span><span style="animation:blink 1s infinite">|</span></div>
            <div class="keyboard" id="kb-container"></div>
        </div>

        <!-- RESULT SCREEN -->
        <div id="result-screen">
            <div id="result-capture-area">
                <h2 style="color:#fff; margin-bottom:10px; font-family: 'Courier New', monospace;">GAME OVER</h2>
                <div class="roast-box" id="roast-msg">...</div>
                <div style="margin-bottom:15px;">
                    <span style="font-size:3rem; font-weight:900; color:var(--accent-color); display:block;" id="res-score">0</span>
                    <span style="font-size:0.8rem; color:#666; letter-spacing:2px;">TOTAL SCORE</span>
                </div>
                <div class="stats-grid">
                    <div class="stat-card"><span class="stat-val" id="res-wpm">0</span><span class="stat-lbl">WPM</span></div>
                    <div class="stat-card"><span class="stat-val" id="res-acc">0%</span><span class="stat-lbl">ACC</span></div>
                    <div class="stat-card"><span class="stat-val" id="res-time">0s</span><span class="stat-lbl">TIME</span></div>
                </div>
                <div style="margin-top:10px; font-size:0.9rem; color:#888;">
                    HACKER: <span id="res-player" style="color:#fff; font-weight:bold;"></span>
                </div>
                <div style="font-size:0.7rem; color:#444; margin-top:5px;">ghostkeyboard.net</div>
            </div>
            
            <div style="width:100%; max-width:400px; margin-top:10px;">
                <button class="main-btn" onclick="resetGame()">TRY AGAIN</button>
                <button class="secondary-btn" id="share-btn" onclick="shareResult()">SHARE RESULT</button>
            </div>
        </div>
    </div>

    <script>
        // --- SUPABASE & INIT ---
        const SUPABASE_URL = 'https://dhqegitqiarogxivzcyv.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRocWVnaXRxaWFyb2d4aXZ6Y3l2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM5NzAwMzMsImV4cCI6MjA3OTU0NjAzM30.qnBHT5grVgmoMk1yCQA2_R8J-Q5MBXW3W05bXRS7Xoc';
        let supabase; try { supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY); } catch(e){}

        const config = { diff: 'easy', lang: 'tr', backspace: true };
        let state = { active: false, target: "", input: "", start: 0, timer: null };
        let username = "";
        let audioCtx = null;
        
        const phrases = {
        en: {
        easy: ["linux", "sudo", "code", "joker", "bond", "nasa", "tesla", "mars", "apple", "swift", "react", "node", "java", "ruby", "perl", "bash", "root", "user", "data", "byte", "file", "disk", "hack", "wifi", "grid", "neon", "flux", "core", "bios", "cmos"],
        normal: ["hello world", "winter is coming", "show me the money", "just do it", "control is an illusion", "there is no spoon", "access denied", "system failure", "buffer overflow", "blue screen of death", "fatal error", "stack trace", "brute force", "neural network", "machine learning", "quantum computing", "artificial intelligence","Her ≈üey a≈ük i√ßin", "bizde aileye yamuk olmaz", "Ben aslƒ±nda yoƒüumm"],
        hard: ["sudo rm -rf /", "console.log('Error');", "404: Page not found.", "Houston, we have a problem.", "DROP TABLE users;", "alert('XSS Attack');", "while(true){fork();}", "git commit -m 'fix bug'", "docker-compose up -d", "kubectl get pods","Ay bu k√º√ß√ºk, narin, hassas ve orantƒ±lƒ± kulaklarƒ±m neler duyuyor", "Ne kadar da inanarak bo≈ü konu≈üuyor"]
        },
        tr: {
        easy: ["yazilim", "kod", "kaos", "simit", "kedi", "ezel", "ramiz", "uzay", "vatan", "millet", "veri", "fare", "ekran", "kasa", "modem", "kablo", "dosya", "klasor", "sifre", "hakim", "savci", "polis", "radar", "pilot", "robot", "siber", "bulut", "sunucu", "linux", "sudo", "code", "joker", "bond", "nasa", "tesla", "mars", "apple", "swift", "react", "node", "java", "ruby", "perl", "bash", "root", "user", "data", "byte", "file", "disk", "hack", "wifi", "grid", "neon", "flux", "core", "bios", "cmos"],
        normal: ["kod calisiyor elleme", "o gemi bir gun gelecek", "mesele olmek degil", "burasi karisacak", "sisteme giris yapildi", "baglanti koptu", "guvenlik duvari", "veri tabani hatasi", "mavi ekran verdi", "format atmak lazim", "klavye delikanlisi", "yasasin irkimiz", "bir gece ansizin", "hello world", "winter is coming", "show me the money", "just do it", "control is an illusion", "there is no spoon", "access denied", "system failure", "buffer overflow", "blue screen of death", "fatal error", "stack trace", "brute force", "neural network", "machine learning", "quantum computing", "artificial intelligence", "Her ≈üey a≈ük i√ßin", "biz de aileye yamuk olmaz", "Ben aslƒ±nda yoƒüumm"],
        hard: ["Noktali virgul nerede;", "SELECT * FROM dertler;", "Abi bana site yapsana?", "404 Sayfa Bulunamadi.", "sudo apt-get update", "console.log('Selam');", "if(money < 0) panic();", "git push origin master", "npm install dertler", "Bug√ºn de ba≈ükasƒ± adƒ±na utandƒ±k", "kubectl get pods", "sudo rm -rf /", "console.log('Error');", "404: Page not found.", "Houston, we have a problem.", "DROP TABLE users;", "alert('XSS Attack');", "while(true){fork();}", "git commit -m 'fix bug'", "docker-compose up -d", "Ay bu k√º√ß√ºk, narin, hassas ve orantƒ±lƒ± kulaklarƒ±m neler duyuyor", "Ne kadar da inanarak bo≈ü konu≈üuyor"]
        }
        };
        window.onload = () => {
            const savedName = localStorage.getItem('ghostUsername');
            if(savedName) username = sanitizeUsername(savedName);
            if(supabase) { fetchLeaderboard(); setupRealtimeSubscription(); }
            startCountdown();
            document.getElementById('start-screen').style.display = 'block';
        };

        function initAudio() {
            if (!audioCtx) { const AC = window.AudioContext || window.webkitAudioContext; if(AC) audioCtx = new AC(); }
            if(audioCtx && audioCtx.state === 'suspended') audioCtx.resume();
        }

        function playClick(isEnter=false) {
            if(!audioCtx) return;
            const t = audioCtx.currentTime;
            const osc = audioCtx.createOscillator(); const gain = audioCtx.createGain();
            osc.frequency.setValueAtTime(isEnter?600:800, t); osc.frequency.exponentialRampToValueAtTime(100, t+0.05);
            gain.gain.setValueAtTime(0.1, t); gain.gain.exponentialRampToValueAtTime(0.01, t+0.05);
            osc.connect(gain); gain.connect(audioCtx.destination); osc.start(); osc.stop(t+0.05);
        }

        function startGame() {
            initAudio(); playClick();
            const inp = document.getElementById('username-input'); username = sanitizeUsername(inp.value);
            if(!username || username.length<2){ alert("Enter username!"); return;}
            saveUsername(username);
            
            const pool = phrases[config.lang][config.diff];
            state.target = pool[Math.floor(Math.random()*pool.length)];
            state.input = ""; state.active = true; state.start = Date.now();

            document.getElementById('start-screen').style.display='none';
            document.getElementById('result-screen').style.display='none';
            document.getElementById('game-screen').style.display='flex';
            
            initKeyboard();
            document.getElementById('target-text').textContent = state.target;
            document.getElementById('user-input').textContent = "";
            
            if(state.timer) clearInterval(state.timer);
            state.timer = setInterval(()=>{document.getElementById('timer').textContent=((Date.now()-state.start)/1000).toFixed(1)},50);
        }

        function finish() {
            if(!state.active) return; state.active = false; clearInterval(state.timer);
            const t = (Date.now()-state.start)/1000;
            const acc = calcAcc(state.target, state.input);
            const wpm = Math.round((state.input.length/5)/(t/60))||0;
            const score = Math.floor(wpm * (acc/100));

            saveScoreToCloud(score, wpm, acc, t);

            document.getElementById('game-screen').style.display='none';
            document.getElementById('result-screen').style.display='flex';
            document.getElementById('res-score').textContent=score;
            document.getElementById('res-wpm').textContent=wpm;
            document.getElementById('res-acc').textContent=acc+"%";
            document.getElementById('res-time').textContent=t.toFixed(1)+"s";
            document.getElementById('roast-msg').textContent=getRoast(acc,wpm);
            document.getElementById('res-player').textContent=username;
        }

        function handle(char, el) {
            if(!state.active) return;
            if(navigator.vibrate) navigator.vibrate(5);
            if(el) { el.classList.add('active-key'); setTimeout(()=>el.classList.remove('active-key'),100); }
            if(char==='BACKSPACE') { playClick(); state.input=state.input.slice(0,-1); }
            else {
                state.input+=char;
                let idx = state.input.length-1;
                let exp = config.diff!=='hard'?(state.target[idx]||"").toLowerCase():(state.target[idx]||"");
                let inp = config.diff!=='hard'?char.toLowerCase():char;
                if(exp && inp!==exp) {
                    document.body.classList.add('shake-screen');
                    document.getElementById('input-box-area').classList.add('error-glow');
                    setTimeout(()=>{document.body.classList.remove('shake-screen');document.getElementById('input-box-area').classList.remove('error-glow')},300);
                } else playClick();
            }
            document.getElementById('user-input').textContent=state.input;
        }

        /* --- NATIVE SHARE FUNCTION (TEXT BASED) --- */
        async function shareResult() {
            const acc = document.getElementById('res-acc').textContent;
            const wpm = document.getElementById('res-wpm').textContent;
            const score = document.getElementById('res-score').textContent;
            const diff = config.diff.toUpperCase();
            
            const shareData = {
                title: 'Ghost Keyboard',
                text: `üëª Ghost Keyboard (${diff})\nScore: ${score}\nACC: ${acc} | WPM: ${wpm}\nCan you beat me?`,
                url: window.location.href
            };

            if (navigator.share) {
                try { await navigator.share(shareData); } catch (err) {}
            } else {
                const textToCopy = `${shareData.text}\n${shareData.url}`;
                navigator.clipboard.writeText(textToCopy).then(() => {
                    const btn = document.getElementById('share-btn');
                    const originalText = btn.innerText;
                    btn.innerText = "COPIED!";
                    setTimeout(() => { btn.innerText = originalText; }, 2000);
                });
            }
        }

        /* --- UTILS --- */
        function getRoast(acc, wpm) {
            const pick = (arr) => arr[Math.floor(Math.random() * arr.length)];
            if (wpm === 0) return "AFK? Did you fall asleep? üí§";
    if (acc === 0) return "You missed everything. Are you a Stormtrooper? üî´";

    if (wpm > 250) return pick(["Nice script, bro. ü§ñ", "CYBORG DETECTED ü§ñ", "He is the One. üï∂Ô∏è", "Are you Mr. Robot? üë®‚Äçüíª"]);

    if (wpm >= 100 && acc >= 90) {
        const opts = ["UNLIMITED POWER! ‚ö°"];
        if (acc >= 98) opts.push("He is the One. üï∂Ô∏è (Matrix Code Rain)");
        return pick(opts);
    }

    if (wpm >= 80 && wpm < 100 && acc >= 85) {
        const opts = ["The Force is strong. üåå", "So close! ü§è"];
        if (acc >= 95) opts.push("Legolas aim! üèπ (Elven precision)");
        return pick(opts);
    }

    if (wpm >= 60 && acc < 85) {
        const opts = [];
        if (wpm >= 80 && acc < 60) opts.push("My eyes! üòµ Too fast, too furious, too wrong!");
        if (wpm >= 60 && acc < 70) opts.push("Stormtrooper Aim detected. Pew pew! üî´ (0 hits)");
        if (wpm >= 70) opts.push("Control yourself, Padawan. üßò", "One typo ruined your career. üìâ");
        if (opts.length === 0) return "Slow down!";
        return pick(opts);
    }

    if (wpm < 50 && acc >= 90) {
        const opts = ["Slow... but safe. üöó", "Grandma speed. üëµ"];
        if (wpm < 30 && acc === 100) opts.push("Dial-up Internet vibes... üêå");
        if (wpm < 40 && acc >= 95) opts.push("Ent-ish speed. üå≥");
        return pick(opts);
    }

    if (wpm >= 40 && wpm < 70 && acc >= 85) {
        const opts = ["Not great, not terrible. ‚ò¢Ô∏è"];
        if (wpm < 60) opts.push("NPC Energy. üòê (Need more coffee)");
        return pick(opts);
    }

    if (wpm < 40 && acc < 60) {
        return pick(["Toaster typing? üçû", "Using elbows? üí™", "My eyes hurt. ü´£", "Try using fingers. üñêÔ∏è", "You shall not pass! üßô‚Äç‚ôÇÔ∏è (Because you failed)", "Please delete the app. üíÄ"]);
    }

    return "Emotional Damage. üíî (Try again)";
}

        function sanitizeUsername(v) { return v?v.trim().replace(/[<>'"&]/g,'').substring(0,12):''; }
        function saveUsername(v) { username=sanitizeUsername(v); localStorage.setItem('ghostUsername', username); }
        function calcAcc(a,b) { if(config.diff!=='hard'){a=a.toLowerCase();b=b.toLowerCase();} let m=0,l=Math.max(a.length,b.length); if(l===0)return 0; for(let i=0;i<l;i++)if(a[i]===b[i])m++; return Math.floor((m/l)*100); }
        function setDiff(v,b) { config.diff=v; config.backspace=v!=='hard'; document.querySelectorAll('#diff-row .mode-btn').forEach(k=>k.classList.remove('active')); b.classList.add('active'); document.body.className='theme-'+v; playClick(); }
        function setLang(v,b) { config.lang=v; document.querySelectorAll('#lang-row .mode-btn').forEach(k=>k.classList.remove('active')); b.classList.add('active'); playClick(); }
        function resetGame() { if(supabase) fetchLeaderboard(); document.getElementById('result-screen').style.display='none'; document.getElementById('start-screen').style.display='block'; document.getElementById('username-input').value=username; }

        /* --- DB --- */
        async function fetchLeaderboard() {
            if(!supabase) return; const c=document.getElementById('lb-content'); const t=new Date(); t.setHours(0,0,0,0);
            const {data}=await supabase.from('scores').select('*').gte('created_at',t.toISOString()).order('score',{ascending:false}).limit(10);
            c.innerHTML=''; if(!data||!data.length) c.innerHTML='<div style="text-align:center;color:#666;margin-top:20px">No scores yet today!</div>';
            else { let r=1; data.forEach(d=>{ const row=document.createElement('div'); row.className='lb-row'+(d.username===username?' highlight':''); row.innerHTML=`<span class="lb-rank">#${r++}</span><span class="lb-name">${d.username}</span><span class="lb-score">${d.score}</span>`; c.appendChild(row); }); }
        }
        function setupRealtimeSubscription() { if(supabase) supabase.channel('public:scores').on('postgres_changes',{event:'INSERT',schema:'public',table:'scores'},fetchLeaderboard).subscribe(); }
        async function saveScoreToCloud(s,w,a,t) { if(supabase && w<=350 && a<=100) await supabase.rpc('submit_score_secure',{p_username:username,p_score:s,p_wpm:w,p_accuracy:a,p_time_taken:t}); fetchLeaderboard(); }
        function startCountdown() { setInterval(()=>{ const n=new Date(), t=new Date(n); t.setHours(24,0,0,0); const d=t-n; const h=Math.floor((d/3600000)%24),m=Math.floor((d/60000)%60),s=Math.floor((d/1000)%60); document.getElementById('daily-timer').innerText=`${h}:${m}:${s}`; },1000); }

        function initKeyboard() {
            const c=document.getElementById('kb-container'); c.innerHTML='';
            let r=config.lang==='tr'?["qwertyuƒ±opƒü√º","asdfghjkl≈üi","zxcvbnm√∂√ß"]:["qwertyuiop","asdfghjkl","zxcvbnm"];
            const mk=(ch)=> { let k=document.createElement('div');k.className='key';k.innerHTML=`<span>${ch.toUpperCase()}</span>`; const h=(e)=>{e.preventDefault();handle(ch,k)};k.ontouchstart=h;k.onmousedown=h;return k; };
            let r1=document.createElement('div');r1.className='row';r[0].split('').forEach(x=>r1.appendChild(mk(x)));c.appendChild(r1);
            let r2=document.createElement('div');r2.className='row staggered';r[1].split('').forEach(x=>r2.appendChild(mk(x)));c.appendChild(r2);
            let r3=document.createElement('div');r3.className='row';
            let sh=document.createElement('div');sh.className='key special';sh.innerHTML='<span>‚áß</span>';r3.appendChild(sh);
            r[2].split('').forEach(x=>r3.appendChild(mk(x)));
            let bk=document.createElement('div');bk.className='key special';bk.innerHTML=config.backspace?'<span>‚å´</span>':'<span>üîí</span>';
            const bh=(e)=>{e.preventDefault();if(config.backspace)handle('BACKSPACE',bk)};bk.ontouchstart=bh;bk.onmousedown=bh;r3.appendChild(bk);c.appendChild(r3);
            let r4=document.createElement('div');r4.className='row';
            let k123=document.createElement('div');k123.className='key special';k123.innerHTML='<span>123</span>';r4.appendChild(k123);
            let spc=document.createElement('div');spc.className='key space';spc.innerHTML='<span>space</span>';
            const sh2=(e)=>{e.preventDefault();handle(' ',spc)};spc.ontouchstart=sh2;spc.onmousedown=sh2;r4.appendChild(spc);
            let ent=document.createElement('div');ent.className='key enter';ent.innerHTML='<span>GO</span>';
            const eh=(e)=>{e.preventDefault();finish();playClick(true);};ent.ontouchstart=eh;ent.onmousedown=eh;r4.appendChild(ent);c.appendChild(r4);
        }
    </script>
</body>
</html>
